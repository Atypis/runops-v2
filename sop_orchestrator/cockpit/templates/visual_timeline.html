<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŽ¥ Visual Timeline - Agent Time Machine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        .timeline-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .timeline-header {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .timeline-header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .timeline-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .timeline-main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .browser-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
            position: relative;
        }

        .browser-header {
            background: #333;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .browser-screenshot {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .browser-screenshot img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 4px;
        }

        .action-overlays {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .action-overlay {
            position: absolute;
            border: 3px solid #ff4444;
            border-radius: 50%;
            background: rgba(255, 68, 68, 0.2);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .timeline-sidebar {
            width: 350px;
            background: rgba(0, 0, 0, 0.4);
            border-left: 2px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }

        .timeline-scrubber {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scrubber-container {
            position: relative;
            margin: 15px 0;
        }

        .timeline-slider {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            outline: none;
            cursor: pointer;
            appearance: none;
        }

        .timeline-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .timeline-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .timeline-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }

        .action-details {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .current-state {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .state-url {
            font-size: 14px;
            color: #4CAF50;
            margin-bottom: 5px;
            word-break: break-all;
        }

        .state-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .state-timestamp {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .action-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .action-type {
            display: inline-block;
            background: #2196F3;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .action-type.click { background: #f44336; }
        .action-type.type { background: #2196F3; }
        .action-type.navigate { background: #4CAF50; }
        .action-type.scroll { background: #FF9800; }

        .action-description {
            margin-bottom: 10px;
        }

        .action-success {
            color: #4CAF50;
            font-weight: bold;
        }

        .action-error {
            color: #f44336;
            font-weight: bold;
        }

        .timeline-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .timeline-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }

        .timeline-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .timeline-item.active {
            background: rgba(76, 175, 80, 0.3);
            border-left-color: #4CAF50;
        }

        .timeline-item-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 5px;
        }

        .timeline-item-action {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .timeline-item-url {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .control-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s ease;
        }

        .control-button:hover {
            background: #45a049;
        }

        .control-button.secondary {
            background: #2196F3;
        }

        .control-button.secondary:hover {
            background: #1976D2;
        }

        .control-button.danger {
            background: #f44336;
        }

        .control-button.danger:hover {
            background: #d32f2f;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.live {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        .status-indicator.paused {
            background: #FF9800;
        }

        .status-indicator.stopped {
            background: #f44336;
        }

        .no-screenshot {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(255, 255, 255, 0.5);
            font-size: 18px;
        }

        .export-controls {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .export-controls h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="timeline-container">
        <!-- Header -->
        <div class="timeline-header">
            <h1>ðŸŽ¥ Visual Timeline - Agent Time Machine</h1>
            <div class="timeline-controls">
                <span class="status-indicator live" id="statusIndicator"></span>
                <span id="agentStatus">Agent: Loading...</span>
                <button class="control-button" onclick="toggleLiveMode()" id="liveModeBtn">Live Mode</button>
                <button class="control-button secondary" onclick="exportTimeline()">Export Timeline</button>
                <button class="control-button danger" onclick="clearTimeline()">Clear Timeline</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="timeline-main">
            <!-- Browser View -->
            <div class="browser-view">
                <div class="browser-header">
                    <span id="currentUrl">No URL</span>
                    <span style="margin-left: auto;" id="currentTime">--:--:--</span>
                </div>
                <div class="browser-screenshot">
                    <div class="no-screenshot" id="noScreenshot">
                        ðŸ“· No screenshot available
                    </div>
                    <img id="browserScreenshot" style="display: none;" />
                    <div class="action-overlays" id="actionOverlays"></div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="timeline-sidebar">
                <!-- Scrubber -->
                <div class="timeline-scrubber">
                    <h3>Timeline Navigation</h3>
                    <div class="scrubber-container">
                        <input type="range" class="timeline-slider" id="timelineSlider" 
                               min="0" max="100" value="0" 
                               oninput="scrubToPosition(this.value)" />
                        <div class="timeline-info">
                            <span id="currentPosition">0 / 0</span>
                            <span id="totalDuration">0:00</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="control-button" onclick="previousState()">â—€ Prev</button>
                        <button class="control-button" onclick="nextState()">Next â–¶</button>
                    </div>
                </div>

                <!-- Current State Info -->
                <div class="action-details">
                    <div class="current-state">
                        <div class="state-url" id="stateUrl">No URL</div>
                        <div class="state-title" id="stateTitle">No page title</div>
                        <div class="state-timestamp" id="stateTimestamp">No timestamp</div>
                    </div>

                    <div class="action-info" id="actionInfo" style="display: none;">
                        <div class="action-type" id="actionType">ACTION</div>
                        <div class="action-description" id="actionDescription">No action</div>
                        <div id="actionStatus"></div>
                        <div id="browserUseContext" style="margin-top: 10px; display: none;">
                            <h4 style="font-size: 14px; margin-bottom: 5px;">Browser-Use Context:</h4>
                            <div id="elementIndex" style="font-size: 12px; margin-bottom: 3px;"></div>
                            <div id="elementXPath" style="font-size: 11px; color: rgba(255, 255, 255, 0.7); word-break: break-all;"></div>
                            <div id="elementTag" style="font-size: 12px; margin-top: 3px;"></div>
                        </div>
                    </div>

                    <!-- Browser State Info -->
                    <div class="browser-state-info" style="background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <h4 style="font-size: 14px; margin-bottom: 10px;">Browser State:</h4>
                        <div id="elementsCount" style="font-size: 12px; margin-bottom: 5px;">Interactive Elements: --</div>
                        <div id="tabsCount" style="font-size: 12px; margin-bottom: 5px;">Browser Tabs: --</div>
                        <div id="browserIntegration" style="font-size: 12px; color: #4CAF50;">Browser-Use Integration: Active</div>
                    </div>

                    <!-- Timeline List -->
                    <div class="timeline-list" id="timelineList">
                        <div style="text-align: center; color: rgba(255, 255, 255, 0.5); padding: 20px;">
                            Loading timeline...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Controls -->
        <div class="export-controls">
            <h3>Export Options</h3>
            <div class="export-buttons">
                <button class="control-button secondary" onclick="exportScreenshots()">ðŸ“· Screenshots</button>
                <button class="control-button secondary" onclick="exportReport()">ðŸ“„ PDF Report</button>
                <button class="control-button secondary" onclick="exportVideo()">ðŸŽ¬ Video</button>
                <button class="control-button secondary" onclick="exportData()">ðŸ“Š Raw Data</button>
            </div>
        </div>
    </div>

    <script>
        let timeline = [];
        let currentIndex = 0;
        let isLiveMode = true;
        let agentId = null;
        let websocket = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            loadTimeline();
            setInterval(updateCurrentTime, 1000);
        });

        function initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            websocket = new WebSocket(`${protocol}//${window.location.host}/ws`);
            
            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'timeline_update') {
                    handleTimelineUpdate(data.data);
                } else if (data.type === 'agent_status') {
                    updateAgentStatus(data.data);
                }
            };
        }

        function handleTimelineUpdate(data) {
            timeline.push(data);
            updateTimelineList();
            
            if (isLiveMode) {
                jumpToLatest();
            }
        }

        function updateAgentStatus(data) {
            document.getElementById('agentStatus').textContent = 
                `Agent: ${data.agent_id} (${data.status})`;
            
            const indicator = document.getElementById('statusIndicator');
            indicator.className = `status-indicator ${data.status}`;
        }

        async function loadTimeline() {
            try {
                const response = await fetch('/api/visual-timeline');
                const data = await response.json();
                timeline = data.timeline || [];
                agentId = data.agent_id;
                updateTimelineList();
                if (timeline.length > 0) {
                    jumpToLatest();
                }
            } catch (error) {
                console.error('Failed to load timeline:', error);
            }
        }

        function updateTimelineList() {
            const listElement = document.getElementById('timelineList');
            
            if (timeline.length === 0) {
                listElement.innerHTML = `
                    <div style="text-align: center; color: rgba(255, 255, 255, 0.5); padding: 20px;">
                        No timeline data available
                    </div>
                `;
                return;
            }

            listElement.innerHTML = timeline.map((item, index) => `
                <div class="timeline-item ${index === currentIndex ? 'active' : ''}" 
                     onclick="jumpToIndex(${index})">
                    <div class="timeline-item-time">${formatTime(item.timestamp)}</div>
                    <div class="timeline-item-action">
                        ${item.action ? item.action.description : 'State capture'}
                        ${item.action && item.action.element_index !== null && item.action.element_index !== undefined ? 
                          ` (Element #${item.action.element_index})` : ''}
                    </div>
                    <div class="timeline-item-url">${item.url}</div>
                    <div style="font-size: 10px; color: rgba(255, 255, 255, 0.5); margin-top: 2px;">
                        ${item.clickable_elements_count || 0} interactive elements
                    </div>
                </div>
            `).join('');

            // Update slider
            const slider = document.getElementById('timelineSlider');
            slider.max = Math.max(0, timeline.length - 1);
            slider.value = currentIndex;
            
            document.getElementById('currentPosition').textContent = 
                `${currentIndex + 1} / ${timeline.length}`;
        }

        function jumpToIndex(index) {
            if (index >= 0 && index < timeline.length) {
                currentIndex = index;
                displayState(timeline[index]);
                updateTimelineList();
            }
        }

        function jumpToLatest() {
            if (timeline.length > 0) {
                jumpToIndex(timeline.length - 1);
            }
        }

        function scrubToPosition(value) {
            jumpToIndex(parseInt(value));
        }

        function previousState() {
            if (currentIndex > 0) {
                jumpToIndex(currentIndex - 1);
            }
        }

        function nextState() {
            if (currentIndex < timeline.length - 1) {
                jumpToIndex(currentIndex + 1);
            }
        }

        function displayState(state) {
            // Update URL and title
            document.getElementById('currentUrl').textContent = state.url;
            document.getElementById('stateUrl').textContent = state.url;
            document.getElementById('stateTitle').textContent = state.page_title;
            document.getElementById('stateTimestamp').textContent = formatTime(state.timestamp);

            // Update browser state info
            const elementsCount = state.clickable_elements_count || 0;
            const tabsCount = state.browser_context ? state.browser_context.tabs_count : 0;
            
            document.getElementById('elementsCount').textContent = `Interactive Elements: ${elementsCount}`;
            document.getElementById('tabsCount').textContent = `Browser Tabs: ${tabsCount}`;

            // Update screenshot
            const screenshot = document.getElementById('browserScreenshot');
            const noScreenshot = document.getElementById('noScreenshot');
            
            if (state.screenshot_available) {
                screenshot.src = `/api/screenshot/${state.state_id}`;
                screenshot.style.display = 'block';
                noScreenshot.style.display = 'none';
            } else {
                screenshot.style.display = 'none';
                noScreenshot.style.display = 'flex';
            }

            // Update action info
            const actionInfo = document.getElementById('actionInfo');
            const browserUseContext = document.getElementById('browserUseContext');
            
            if (state.action) {
                actionInfo.style.display = 'block';
                document.getElementById('actionType').textContent = state.action.action_type.toUpperCase();
                document.getElementById('actionType').className = `action-type ${state.action.action_type}`;
                document.getElementById('actionDescription').textContent = state.action.description;
                
                const statusElement = document.getElementById('actionStatus');
                if (state.action.success) {
                    statusElement.innerHTML = '<span class="action-success">âœ“ Success</span>';
                } else {
                    statusElement.innerHTML = `<span class="action-error">âœ— Failed: ${state.action.error_message}</span>`;
                }
                
                // Show browser-use context if available
                if (state.action.element_index !== null && state.action.element_index !== undefined) {
                    browserUseContext.style.display = 'block';
                    document.getElementById('elementIndex').textContent = `Element Index: ${state.action.element_index}`;
                    
                    if (state.action.dom_context) {
                        const domContext = state.action.dom_context;
                        document.getElementById('elementXPath').textContent = `XPath: ${domContext.xpath || 'N/A'}`;
                        document.getElementById('elementTag').textContent = `Tag: <${domContext.tag_name || 'unknown'}>`;
                    } else {
                        document.getElementById('elementXPath').textContent = 'XPath: N/A';
                        document.getElementById('elementTag').textContent = 'Tag: N/A';
                    }
                } else {
                    browserUseContext.style.display = 'none';
                }
            } else {
                actionInfo.style.display = 'none';
                browserUseContext.style.display = 'none';
            }

            // Clear action overlays (browser-use already provides highlighting)
            document.getElementById('actionOverlays').innerHTML = '';
        }

        function toggleLiveMode() {
            isLiveMode = !isLiveMode;
            const btn = document.getElementById('liveModeBtn');
            btn.textContent = isLiveMode ? 'Live Mode' : 'Manual Mode';
            btn.className = isLiveMode ? 'control-button' : 'control-button secondary';
        }

        function updateCurrentTime() {
            document.getElementById('currentTime').textContent = 
                new Date().toLocaleTimeString();
        }

        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString();
        }

        // Export functions
        async function exportTimeline() {
            try {
                const response = await fetch('/api/export-timeline', { method: 'POST' });
                const data = await response.json();
                window.open(data.download_url, '_blank');
            } catch (error) {
                alert('Export failed: ' + error.message);
            }
        }

        async function exportScreenshots() {
            alert('Screenshot export feature coming soon!');
        }

        async function exportReport() {
            alert('PDF report export feature coming soon!');
        }

        async function exportVideo() {
            alert('Video export feature coming soon!');
        }

        async function exportData() {
            const dataStr = JSON.stringify(timeline, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `timeline_${agentId}_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function clearTimeline() {
            if (confirm('Are you sure you want to clear the timeline?')) {
                timeline = [];
                currentIndex = 0;
                updateTimelineList();
                document.getElementById('browserScreenshot').style.display = 'none';
                document.getElementById('noScreenshot').style.display = 'flex';
            }
        }
    </script>
</body>
</html> 